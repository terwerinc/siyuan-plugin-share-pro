# Change: 增量分享功能

## 1. 功能背景

当前的文档分享功能需要用户手动选择要分享的文档，当文档数量较多且只有部分文档发生变更时，手动识别和选择变更文档的过程变得繁琐且容易出错。特别是在大型知识库管理场景下，用户希望能够快速识别并仅分享发生变更的文档，类似于Obsidian Publish的增量发布概念。

增量分享功能旨在简化这一流程，通过自动检测自上次分享后发生变更的文档，并提供直观的界面让用户轻松选择和发布这些变更，从而显著提升工作效率。

## 2. 变更内容

1. **文档变更检测机制**：
   - 实现变更时间戳记录系统，追踪每次分享操作
   - 开发文档更新状态检测算法，比对文档修改时间与上次分享时间
   - 设计变更文档缓存机制，提高检测效率

2. **增量分享界面**：
   - 创建新的增量分享页面，采用分组结构展示变更文档
   - 顶部分组显示：已分享文档中发生更新的内容
   - 底部分组显示：上次操作后新增的未分享文档，默认折叠状态
   - 实现文档选择功能，支持单选、多选和全选
   - 设计直观的视觉反馈，清晰标识文档变更状态和分享历史

3. **一键增量分享功能**：
   - 开发批量分享API扩展，支持同时分享多个文档
   - 实现增量分享进度跟踪和状态反馈
   - 添加分享结果汇总和错误处理机制
   - 实现智能重试机制：
     - 网络错误自动重试3次（指数退避策略）
     - 服务端5xx错误延迟重试（30秒后重试）
     - 4xx错误立即失败并记录详细日志
   - 添加分享队列管理：
     - 支持暂停/继续批量分享操作
     - 支持仅重试失败项功能
     - 保存分享进度到本地，系统重启后可恢复
     - 显示队列状态和预估剩余时间

4. **新UI融合**：
   - 在新UI模式下集成增量分享功能入口
   - 设计符合新UI风格的增量分享界面
   - 确保在新旧UI中均保持一致的用户体验

5. **配置与偏好设置**：
   - 添加增量分享相关的全局配置选项
   - 实现用户偏好记忆功能，记住上次的选择行为
   - 提供增量分享历史记录查询功能

. **黑名单管理系统**：
   - 实现笔记本级别和文档级别的黑名单管理
   - 设计黑名单继承机制，笔记本黑名单自动排除所有子文档
   - 提供直观的黑名单配置界面和管理工具
   - 确保黑名单过滤在所有增量分享操作中生效
   - 提供常见使用场景示例（草稿笔记本、个人日记、敏感资料等）
   - 支持快速添加：右键菜单"添加到分享黑名单"选项
   - **存储方案**：文档级别的黑名单存储在文档属性中，笔记本级别的黑名单存储在插件配置中，利用思源笔记本地存储机制实现持久化

7. **用户引导体验设计**：
   - 首次使用引导：
     - 打开增量分享界面时，检测是否为首次使用
     - 展示简短的功能介绍卡片（可关闭，不再提示）
     - 提供"快速开始"视频教程链接
   - 空状态提示：
     - 当没有变更文档时，显示友好的空状态插图
     - 说明可能的原因："所有文档都已是最新分享状态"
     - 提供建议操作："修改文档后再来试试"
   - 黑名单使用指引：
     - 在黑名单设置页面添加"为什么需要黑名单"说明
     - 提供预设模板：一键添加常见黑名单类型

8. **查询与统计**：
   - 统计报表功能：
     - 分享次数趋势图（最近30天折线图）
     - 最常分享的Top 10文档（柱状图）
     - 分享成功率统计（百分比显示）
     - 黑名单命中统计（被过滤的文档数量）

9. **数据一致性保证**：
   - 定期校验分享历史与实际状态：
     - 后台定时任务每24小时自动检查一次
     - 清理已删除文档的历史记录
     - 标记状态异常的记录供用户手动处理
   - 黑名单同步机制：
     - 添加到黑名单时，自动标记该文档的分享历史
     - 提供"取消黑名单中文档的分享"一键操作
     - 从黑名单移除时，提示用户是否重新分享

## 3. 影响分析

1. **功能兼容性**：
   - 新增功能不影响现有分享功能的正常使用
   - 确保与已有的分享配置和权限系统兼容
   - 维持与第三方服务和API的兼容性

2. **UI变更**：
   - 在分享管理界面添加增量分享入口
   - 在新UI模式下整合到现有的分享工作流程中
   - 可能需要调整部分分享相关的UI组件布局
   - 需要新增黑名单管理相关的设置界面和操作控件

3. **性能影响**：
   - 文档变更检测可能对大型知识库产生短暂的性能开销
   - 批量分享操作需要优化以避免长时间锁定
   - 需要考虑增量检测的缓存策略以提高重复操作的性能
   - 黑名单过滤机制在大规模知识库中需要高效实现，避免性能瓶颈
   - 具体性能目标：
     - 1000文档变更检测：< 2秒
     - 5000文档变更检测：< 5秒
     - 10000文档变更检测：< 10秒
     - 变更检测期间UI保持响应，不阻塞用户操作
   - 优化策略：
     - 使用Web Worker进行变更检测，不阻塞主线程
     - 增量检测结果缓存5分钟，避免重复计算
     - 批量分享并发数限制为5个，避免服务端压力
     - 支持虚拟滚动加载变更结果（每页100条）
     - 黑名单过滤使用HashSet数据结构，O(1)查询复杂度

4. **存储需求**：
   - 需要额外存储空间记录文档分享历史和变更时间戳
   - 变更检测缓存可能增加内存占用
   - 分享历史记录需要定期清理机制
   - 黑名单配置需要持久化存储，占用少量额外空间

## 4. 迁移计划

1. **向后兼容性**：
   - 所有新增功能均保持可选性，默认不影响现有用户的工作流
   - 对未使用增量分享功能的用户，维持原有分享体验不变
   - 确保黑名单过滤不会影响已建立的分享链接和访问权限

2. **数据迁移**：
   - 首次使用增量分享功能时，自动记录当前所有已分享文档的时间戳
   - 提供手动同步历史分享记录的选项
   - 创建空的黑名单配置，为用户提供干净的初始状态

3. **推广与引导**：
   - 在适当位置添加增量分享功能的引导提示，包括黑名单功能介绍
   - 提供简短的功能说明和使用教程，解释增量分享和黑名单功能的使用方法

4. **国际化支持**：
   - 所有新增文案均需提供中文和英文翻译
   - 翻译键命名规范：incrementalShare.xxx
   - 关键文案需要提供详细的上下文说明，确保翻译准确

5. **移动端适配**：
   - 增量分享界面在移动端自动切换为单列布局
   - 触摸友好的操作：增大按钮点击区域（最小44x44px）
   - 支持手势操作：左滑显示操作菜单
   - 简化移动端UI：隐藏次要信息，保留核心功能

6. **异常场景处理**：
   - 网络异常：显示离线提示，保存操作队列，网络恢复后自动继续
   - 服务端异常：友好的错误提示，提供重试按钮
   - 数据损坏：自动备份配置，提供恢复默认设置选项
   - 权限不足：明确提示需要的权限，提供帮助链接

7. **用户行为分析（匿名）**：
   - 收集功能使用频率（不涉及文档内容）
   - 统计变更检测平均文档数量
   - 记录批量分享的平均成功率
   - 收集黑名单平均使用数量
   - 所有数据匿名化，仅用于产品优化

## 5. 总结

增量分享功能将显著提升用户在管理大型知识库时的工作效率，特别是对于频繁更新和分享文档的用户。通过自动检测变更文档并提供直观的界面，用户可以快速识别和发布必要的更新，避免不必要的重复分享操作。同时，该功能将与新UI模式无缝融合，为用户提供一致且现代化的使用体验。

新增的黑名单功能是对增量分享的重要补充，使用户能够精确控制哪些笔记本和文档不应被包含在增量分享中。这对于含有敏感内容、草稿或个人笔记的知识库尤为重要，确保用户可以安全地进行增量分享而不必担心意外暴露不想公开的内容。

这项功能类似Obsidian Publish的增量发布概念，为思源笔记用户提供更加流畅和高效的知识库分享体验。通过精心设计的UI界面、灵活的配置选项和强大的黑名单管理系统，用户可以轻松掌握和使用这一功能，为大型知识库的管理和分享带来全新的可能性。