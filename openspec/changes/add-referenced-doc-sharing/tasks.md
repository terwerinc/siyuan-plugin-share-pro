# 分享引用文档功能 - 任务列表

## Change ID

`add-referenced-doc-sharing`

## 任务状态

### 当前实现状态

提案已完成，但代码实现尚未开始。当前 ShareOptions 和 SingleDocSetting 仅包含密码和过期时间相关字段，尚未添加 shareReferencedDocs 字段。

### 待办
- [ ] 扩展 SettingKeys 枚举，添加 CUSTOM_SHARE_REFERENCED_DOCS 配置键
- [ ] 扩展 ShareOptions 类，添加 shareReferencedDocs 字段
- [ ] 更新 ShareProConfig 类，添加 shareReferencedDocs 全局配置
- [ ] 扩展 SingleDocSetting 类，添加 shareReferencedDocs 字段
- [ ] 更新 SettingService 方法，支持引用文档分享配置
- [ ] 修改 ShareService，添加提取引用和递归分享功能：
  - [ ] 实现DOM解析（正则表达式：`/\(\((\d{14}-[a-z0-9]{7})\)\)/g`）
  - [ ] 优先使用思源API查询引用关系（SQL）
  - [ ] 实现引用深度限制（默认3层，可配置1-5层）
  - [ ] 实现循环引用检测（HashSet）
  - [ ] 实现BFS递归分享算法
  - [ ] 实现并发控制（最多3个并发）
- [ ] 更新 UI 组件，添加引用文档分享开关：
  - [ ] 实现引用关系树可视化预览
  - [ ] 支持手动选择/排除引用文档
  - [ ] 显示引用文档总数、层级、预估时间
  - [ ] 实现分享进度显示（X/Y、百分比、剩余时间）
  - [ ] 支持取消分享操作
- [ ] 实现智能排除规则：
  - [ ] 自动排除黑名单中的引用
  - [ ] 自动排除其他笔记本的引用（可配置）
  - [ ] 支持正则表达式自定义排除
- [ ] 区分文档引用和块引用，分别配置
- [ ] 实现智能重试机制：
  - [ ] 网络错误自动重试3次（指数退避：1s, 2s, 4s）
  - [ ] 服务端5xx错误延迟30秒重试
  - [ ] 4xx错误立即失败并记录日志
- [ ] 实现批量分享队列管理：
  - [ ] 支持暂停/继续批量分享操作
  - [ ] 支持仅重试失败项功能
  - [ ] 保存分享进度到本地存储
  - [ ] 显示队列状态和预估剩余时间
- [ ] 实现数据一致性保证：
  - [ ] 分享前验证引用关系有效性
  - [ ] 检测引用文档是否存在
  - [ ] 无效引用标记并跳过
- [ ] 实现数据统计与分析：
  - [ ] 显示引用文档分享统计（总引用数、层级分布）
  - [ ] 展示引用深度趋势图
  - [ ] 显示最常被引用的文档Top 10
  - [ ] 分析引用关系密集度
  - [ ] 提供引用关系优化建议
- [ ] 移动端适配（简化列表、触摸操作、全屏预览）
- [ ] 国际化（referencedDocs.xxx 命名空间，包括：enable、depth、preview、circular、excluded、retrying、queue、estimate、treeView）
- [ ] 编写单元测试和集成测试
- [ ] 编写用户文档和使用教程

### 进行中
无

### 已完成
- [x] 创建引用文档分享功能提案和规范文档

## 实施建议

### 优先级
低优先级

### 原因
1. 增量分享功能还未完全完成，应优先完成已开始的功能
2. 引用文档分享是增强功能，不是核心功能
3. 需要分析思源笔记 DOM 结构来提取引用，实现复杂度较高

### 建议行动
- 等待增量分享功能完全实现并测试通过后，再开始此功能
- 可先进行技术预研：分析思源笔记中引用文档的 DOM 结构

### 验收标准

1. 用户可以在全局设置中配置是否默认分享引用文档
2. 用户可以在单次分享时覆盖全局设置
3. 开启引用文档分享后，所有被引用的文档会被自动分享
4. 系统会根据思源笔记的DOM格式正确提取并分享所有被引用的文档
5. 在新UI模式下，个性化设置中包含引用文档分享选项
6. 现有功能不受影响，保持向后兼容
7. 引用深度限制正常工作（默认3层，可调整至5层）
8. 循环引用检测有效，不会陷入无限循环
9. 引用关系树可视化预览工作正常
10. 支持手动选择/排除特定引用文档
11. 黑名单过滤对引用文档同样生效
12. 性能目标：50个引用文档限制，超过提示分批
13. 分享进度实时显示，支持取消操作
14. 移动端适配测试通过
15. 国际化文案完整（referencedDocs.xxx）
16. 异常场景处理完善（删除、权限、解析失败）
17. 智能重试机制工作正常：
    - 网络错误自动重试3次（指数退避）
    - 服务端错误延迟重试
    - 批量分享支持暂停/继续/仅重试失败项
18. 数据一致性验证：
    - 分享前验证引用关系有效性
    - 无效引用被正确标记和跳过
    - 并发控制有效（最多3个并发）
19. 统计分析功能完整：
    - 引用统计准确（总数、层级分布）
    - 引用深度趋势图正常显示
    - Top 10常被引用文档列表准确
    - 引用关系优化建议合理