# Change: 分享引用文档功能

## Why
当前插件只支持分享单个文档，当文档中引用了其他文档时，这些引用的文档无法被访问，导致分享内容不完整。需要实现分享文档时同时分享其引用的文档，并提供全局和新UI模式下的个性化开关。

## What Changes
- 在 ShareService 中实现引用文档的递归分享逻辑（引用文档提取方法将根据思源笔记的DOM格式进行专门实现）
- 扩展 ShareOptions 类，支持 shareReferencedDocs 配置项
- 在 SettingKeys 中添加 CUSTOM_SHARE_REFERENCED_DOCS 配置键
- 在 ShareProConfig 中添加 shareReferencedDocs 全局配置
- 在 UI 组件中添加对应的开关选项

### 引用文档提取与分享策略

1. **引用深度限制**：
   - 默认最大递归深度为3层，避免过度分享
   - 可在设置中调整（1-5层可选）
   - 超过深度限制的引用不再继续分享，并记录日志
   - 在分享前预览中显示被截断的引用

2. **循环引用检测**：
   - 维护已处理文档ID列表（HashSet）
   - 检测到循环引用时跳过并记录警告日志
   - 在结果报告中显示循环引用的文档
   - 提供"循环引用关系图"可视化展示

3. **引用关系可视化**：
   - 分享前预览引用关系树结构
   - 显示将要分享的文档总数和层级关系
   - 允许用户手动排除特定引用文档
   - 使用树形图展示，支持展开/折叠

4. **精细化引用控制**：
   - 引用类型区分：
     - 文档引用：((doc-id)) 格式
     - 块引用：((block-id)) 格式
     - 支持分别配置是否分享
   - 选择性分享：
     - 分享前显示所有引用文档列表（按层级分组）
     - 支持手动勾选要分享的引用
     - 记住用户的选择偏好（下次默认勾选）
   - 智能排除规则：
     - 自动排除黑名单中的引用文档
     - 自动排除其他笔记本的引用（可配置）
     - 支持自定义排除规则（正则表达式匹配）

5. **性能与体验优化**：
   - 分享前预估：
     - 计算引用文档总数和层级深度
     - 预估分享所需时间（每个文档约3秒）
     - 显示存储空间占用预估
     - 询问用户确认后开始分享
   - 进度反馈：
     - 实时显示分享进度（X/Y）和百分比
     - 显示当前正在处理的文档名称和层级
     - 显示预估剩余时间
     - 支持取消分享操作（已分享的不回滚）
   - 性能限制：
     - 单次分享引用文档数量限制为50个
     - 超过限制时提示用户分批分享
     - 提供"仅分享首层引用"快捷选项

### 技术实现细节

1. **DOM解析实现方案**：
   - 引用识别策略：
     - 使用正则表达式：`/\(\((\d{14}-[a-z0-9]{7})\)\)/g`
     - 区分文档ID（20位）和块ID（21位）
     - 支持嵌套的块引用解析
   - 兼容性处理：
     - 优先使用思源API获取引用关系（sql查询）
     - DOM解析作为备用方案
     - 记录不兼容的情况并上报日志
   - 引用类型处理：
     - 文档引用：直接分享目标文档
     - 块引用：分享块所在的文档（可配置）

2. **递归分享算法**：
   - 使用广度优先遍历（BFS）算法
   - 维护待处理队列和已处理集合
   - 支持暂停/继续和断点续传
   - 实现并发控制（最多3个并发分享）

## Impact
- 影响的规范：share
- 影响的代码：`src/service/ShareService.ts`、`src/models/ShareOptions.ts`、`src/utils/SettingKeys.ts`、`src/models/ShareProConfig.ts`、UI 组件

### 功能交互设计

1. **与增量分享的协同**：
   - 增量分享时，引用文档分享设置自动继承
   - 明确说明：增量检测会包含所有引用的文档
   - 黑名单过滤优先级最高
   - 引用深度限制在增量分享中同样生效

2. **与子文档分享的协同**：
   - 同时开启时，先处理子文档，再处理引用
   - 去重处理，避免同一文档多次分享
   - 在预览中明确标记哪些文档来自子文档，哪些来自引用

3. **性能影响**：
   - 引用解析需要3-5秒（取决于文档大小）
   - 大量引用时分享时间明显增加
   - 需要明确告知用户预期时间
   - 提供取消机制，避免长时间等待

### 移动端适配

- 引用关系树在移动端以简化列表显示
- 支持触摸展开/折叠节点
- 预览页面占据全屏，提供更好的可视化体验

### 异常场景处理

- 引用文档已删除：跳过并记录日志，提示用户
- 引用文档权限不足：显示明确的错误信息
- 循环引用检测失败：防御性编程，设置最大迭代次数
- 引用解析失败：降级处理，仅分享当前文档

### 国际化支持

- 所有新增文案使用 `referencedDocs.xxx` 命名空间
- 关键文案：
  - `referencedDocs.enable`: 启用引用文档分享
  - `referencedDocs.depth`: 引用深度
  - `referencedDocs.preview`: 引用预览
  - `referencedDocs.circular`: 检测到循环引用
  - `referencedDocs.excluded`: 已排除的引用