# Change: 增量分享功能

## 1. 功能背景

当前的文档分享功能需要用户手动选择要分享的文档，当文档数量较多且只有部分文档发生变更时，手动识别和选择变更文档的过程变得繁琐且容易出错。特别是在大型知识库管理场景下，用户希望能够快速识别并仅分享发生变更的文档，类似于Obsidian Publish的增量发布概念。

增量分享功能旨在简化这一流程，通过自动检测自上次分享后发生变更的文档，并提供直观的界面让用户轻松选择和发布这些变更，从而显著提升工作效率。

## 2. 变更内容

1. **文档变更检测机制**：
   - 实现变更时间戳记录系统，追踪每次分享操作
   - 开发文档更新状态检测算法，比对文档修改时间与上次分享时间
   - 设计变更文档缓存机制，提高检测效率

2. **增量分享界面**：
   - 创建新的增量分享页面，采用分组结构展示变更文档
   - 顶部分组显示：已分享文档中发生更新的内容
   - 底部分组显示：上次操作后新增的未分享文档，默认折叠状态
   - 实现文档选择功能，支持单选、多选和全选
   - 设计直观的视觉反馈，清晰标识文档变更状态和分享历史

3. **一键增量分享功能**：
   - 开发批量分享API扩展，支持同时分享多个文档
   - 实现增量分享进度跟踪和状态反馈
   - 添加分享结果汇总和错误处理机制

4. **新UI融合**：
   - 在新UI模式下集成增量分享功能入口
   - 设计符合新UI风格的增量分享界面
   - 确保在新旧UI中均保持一致的用户体验

5. **配置与偏好设置**：
   - 添加增量分享相关的全局配置选项
   - 实现用户偏好记忆功能，记住上次的选择行为
   - 提供增量分享历史记录查询功能

6. **黑名单管理系统**：
   - 实现笔记本级别和文档级别的黑名单管理
   - 设计黑名单继承机制，笔记本黑名单自动排除所有子文档
   - 提供直观的黑名单配置界面和管理工具
   - 确保黑名单过滤在所有增量分享操作中生效

## 3. 影响分析

1. **功能兼容性**：
   - 新增功能不影响现有分享功能的正常使用
   - 确保与已有的分享配置和权限系统兼容
   - 维持与第三方服务和API的兼容性

2. **UI变更**：
   - 在分享管理界面添加增量分享入口
   - 在新UI模式下整合到现有的分享工作流程中
   - 可能需要调整部分分享相关的UI组件布局
   - 需要新增黑名单管理相关的设置界面和操作控件

3. **性能影响**：
   - 文档变更检测可能对大型知识库产生短暂的性能开销
   - 批量分享操作需要优化以避免长时间锁定
   - 需要考虑增量检测的缓存策略以提高重复操作的性能
   - 黑名单过滤机制在大规模知识库中需要高效实现，避免性能瓶颈

4. **存储需求**：
   - 需要额外存储空间记录文档分享历史和变更时间戳
   - 变更检测缓存可能增加内存占用
   - 分享历史记录需要定期清理机制
   - 黑名单配置需要持久化存储，占用少量额外空间

## 4. 迁移计划

1. **向后兼容性**：
   - 所有新增功能均保持可选性，默认不影响现有用户的工作流
   - 对未使用增量分享功能的用户，维持原有分享体验不变
   - 确保黑名单过滤不会影响已建立的分享链接和访问权限

2. **数据迁移**：
   - 首次使用增量分享功能时，自动记录当前所有已分享文档的时间戳
   - 提供手动同步历史分享记录的选项
   - 创建空的黑名单配置，为用户提供干净的初始状态

3. **推广与引导**：
   - 在适当位置添加增量分享功能的引导提示，包括黑名单功能介绍
   - 提供简短的功能说明和使用教程，解释增量分享和黑名单功能的使用方法

## 5. 总结

增量分享功能将显著提升用户在管理大型知识库时的工作效率，特别是对于频繁更新和分享文档的用户。通过自动检测变更文档并提供直观的界面，用户可以快速识别和发布必要的更新，避免不必要的重复分享操作。同时，该功能将与新UI模式无缝融合，为用户提供一致且现代化的使用体验。

新增的黑名单功能是对增量分享的重要补充，使用户能够精确控制哪些笔记本和文档不应被包含在增量分享中。这对于含有敏感内容、草稿或个人笔记的知识库尤为重要，确保用户可以安全地进行增量分享而不必担心意外暴露不想公开的内容。

这项功能类似Obsidian Publish的增量发布概念，为思源笔记用户提供更加流畅和高效的知识库分享体验。通过精心设计的UI界面、灵活的配置选项和强大的黑名单管理系统，用户可以轻松掌握和使用这一功能，为大型知识库的管理和分享带来全新的可能性。