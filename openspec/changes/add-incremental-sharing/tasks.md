好几# 增量分享功能任务列表

## Change ID
`add-incremental-sharing`

## 任务列表

### 核心功能实现
- [x] 在 SettingKeys.ts 中添加增量分享相关配置键，包括黑名单配置
- [x] 在 ShareProConfig.ts 中扩展增量分享配置字段，添加黑名单相关配置
- [x] 创建 ShareHistory.ts 模型，实现分享历史记录管理
- [x] 创建 IncrementalShareService.ts，实现变更检测和批量分享逻辑
- [x] 创建 ShareBlacklist.ts 模型，实现黑名单管理功能
- [x] 扩展 ShareService.ts，增加 detectChangedDocuments 和 bulkShareDocuments 方法
- [x] 实现基于黑名单的文档过滤机制，确保黑名单中的内容不被包含在增量分享中

### UI界面开发
- [x] 创建 IncrementalShareUI.svelte 组件，实现分组式文档树展示和选择功能
- [x] 实现「已分享文档的更新」分组的展示和交互逻辑
- [x] 实现「新增文档」分组的展示和默认折叠功能
- [x] 创建 ShareBlacklistUI.svelte 组件，实现黑名单管理界面
- [x] 在增量分享界面中标识黑名单项目的状态
- [ ] 在新UI模式中集成增量分享入口和界面
- [ ] 在设置页面添加黑名单管理配置项
- [x] 更新 i18n 翻译文件，添加增量分享相关文本，包括黑名单功能
- [ ] 实现首次使用引导和空状态提示
- [ ] 实现分享历史查询界面（搜索、筛选、导出CSV）
- [ ] 实现统计报表页面（趋势图、Top 10、成功率）

### 配置与集成
- [x] 修改 SettingService.ts，支持增量分享配置的管理（已实现黑名单管理相关方法）
- [x] 扩展 ShareResult.ts，支持批量操作结果展示（已在 IncrementalShareService 中定义 BulkShareResult 接口）
- [x] 确保与现有分享功能和权限系统的兼容性

### 增强功能实现
- [x] 实现智能重试机制（网络错误3次重试、服务端错误延迟重试）
- [x] 实现分享队列管理（暂停/继续、仅重试失败项、断点续传）
- [ ] 实现ShareHistory和ShareBlacklist接口的具体实现类（持久化存储）
- [ ] 实现数据一致性检查（定时24小时校验）
- [x] 实现Web Worker变更检测以不阻塞UI
- [x] 实现虚拟滚动加载（每页100条）
- [ ] 实现右键菜单快速添加黑名单功能

## 当前实现状态

### 已实现功能
- [x] 增量分享核心服务（IncrementalShareService）已完整实现
- [x] 分享历史记录管理（ShareHistory 接口定义）
- [x] 黑名单管理系统（ShareBlacklist 接口定义）
- [x] 文档变更检测算法（detectChangedDocuments 方法）
- [x] 批量分享功能（bulkShareDocuments 方法）
- [x] UI 组件开发完成（IncrementalShareUI.svelte、ShareBlacklistUI.svelte）
- [x] 国际化翻译文件更新
- [x] 批量分享并发控制（限制5个并发）
- [x] 智能重试机制（网络错误3次重试、5xx延迟30秒重试、4xx立即失败）
- [x] 分享队列管理系统（暂停/继续、断点续传、进度显示）
- [x] 虚拟滚动加载（使用 svelte-virtual-list，每页100条）
- [x] Web Worker 变更检测（不阻塞主线程）
- [x] 检测结果缓存机制（5分钟有效期）

### 待完善功能
- [ ] 在新UI模式中集成增量分享入口（UI组件已创建，需要集成到新UI流程）
- [ ] 在设置页面添加黑名单管理配置项（BlacklistSetting.svelte 已创建）
- [ ] ShareHistory 和 ShareBlacklist 接口的具体实现类（当前仅定义接口）

## 验收标准

### 1. 文档变更检测与分组
- [x] 系统能正确识别自上次分享后修改的所有文档
- [x] 系统能正确识别新增的未分享过的文档
- [x] 变更检测结果应以分组方式展示：「已分享文档的更新」和「新增文档」
- [ ] 「新增文档」分组默认应处于折叠状态（UI 已实现，需测试）
- [x] 每个文档应显示正确的变更状态（新增/修改）和最后修改时间
- [ ] 对于大型知识库（1000+文档），变更检测时间不应超过3秒（需性能测试）

### 2. 文档选择功能
- [ ] 用户能在文档树中单选、多选和全选文档（UI 已实现，需测试）
- [ ] 界面应实时显示已选择文档的数量（UI 已实现，需测试）
- [ ] 支持按目录层级进行选择操作（需验证）
- [ ] 用户的选择偏好应被正确记忆（配置已支持，需测试）

### 3. 批量分享操作
- [x] 系统能成功批量分享所有选中的文档
- [x] 分享过程中应显示实时进度和状态（已实现结果返回）
- [x] 分享完成后应提供清晰的结果汇总（BulkShareResult 包含详细结果）
- [x] 对于错误情况应提供明确的错误提示和处理建议

### 4. UI体验
- [ ] 增量分享界面应具有直观、易用的设计
- [ ] 在新旧UI模式下均能正常工作且保持一致的用户体验
- [ ] 应提供足够的视觉反馈标识文档状态和操作结果
- [ ] 界面响应速度应满足用户期望，无明显卡顿

### 5. 配置功能
- [ ] 用户能通过设置页面配置增量分享的行为
- [ ] 配置选项应包括启用状态、默认选择行为等
- [ ] 用户的配置应被正确保存并在下次使用时应用
- [ ] 应提供清除分享历史记录的选项

### 6. 黑名单功能
- [x] 用户能添加、移除和查看笔记本级别黑名单（接口已定义）
- [x] 用户能添加、移除和查看文档级别黑名单（接口已定义）
- [x] 黑名单中的笔记本及其所有子文档不应出现在增量分享列表中（已实现过滤逻辑）
- [x] 黑名单中的单独文档不应出现在增量分享列表中（已实现过滤逻辑）
- [ ] 系统应在UI中清晰标识黑名单项目的状态（UI 已实现，需测试）
- [ ] 黑名单设置应正确保存并在系统重启后保持有效（需实现持久化存储）

### 7. 性能与兼容性
- [ ] 增量分享功能不应显著增加系统资源占用
- [ ] 应与现有的分享功能和权限系统完全兼容
- [ ] 在不同规模的知识库中均能正常工作
- [ ] 应正确处理各种边缘情况，如无历史记录、文档权限不足等
- [ ] 性能目标达成：1000文档<2秒、5000文档<5秒、10000文档<10秒
- [ ] 移动端适配测试通过（单列布局、触摸友好、最小44x44px点击区）
- [ ] 国际化文案完整（incrementalShare.xxx 命名空间）