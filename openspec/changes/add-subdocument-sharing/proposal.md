# Change: 分享子文档功能

## Why

当前在分享文档时，只能单独分享指定的文档，无法自动包含该文档下的所有子文档。在实际使用场景中，用户经常需要分享整个文档树结构，特别是在使用思源笔记的目录功能时，一个目录下可能包含多个相关的子文档。目前的实现方式要求用户手动逐个分享每个子文档，操作繁琐且容易遗漏。

为了提升用户体验，需要实现一个功能，允许用户在分享文档时，选择是否同时分享该文档下的所有子文档。这样可以确保分享的内容结构完整，避免出现链接断开或内容缺失的情况。

## What Changes

1. 在ShareOptions类中添加`shareSubdocuments`属性，用于控制是否分享子文档
2. 在SettingKeys.ts中添加`CUSTOM_SHARE_SUBDOCUMENTS`配置键
3. 在ShareProConfig.ts中添加全局默认配置选项
4. 在SingleDocSetting.ts中添加单次分享的子文档分享选项
5. 在SettingService.ts中实现配置的同步和管理
6. 在ShareService.ts中实现子文档的递归获取和分享逻辑
7. 确保与新UI和旧UI的兼容性，在分享对话框中添加相应的选项

### 子文档递归策略

1. **深度控制**：
   - 默认递归所有层级，但最多100个子文档
   - 超过100个时，提示用户并询问是否继续
   - 提供"仅分享N层子文档"选项（1-10层可选）
   - 显示当前文档的子文档总数和最大深度

2. **性能优化**：
   - 使用广度优先遍历（BFS）算法获取子文档
   - 子文档信息缓存1分钟，避免重复查询
   - 支持异步加载子文档树，不阻塞UI
   - 实现虚拟滚动，大量子文档时也保持流畅

3. **分享前预览**：
   - 子文档树可视化：
     - 展示完整的子文档树结构（文件夹形式）
     - 标记哪些文档会被分享（绿色勾选）
     - 标记哪些文档在黑名单中（灰色禁用）
     - 显示总文档数和预估大小
   - 用户确认：
     - 超过20个子文档时，要求用户确认
     - 显示"上次分享了X个子文档"提示
     - 提供"记住我的选择、不再提示"选项

4. **选择性分享**：
   - 支持手动勾选/取消特定子文档
   - 支持按层级全选/反选
   - 记住用户的选择偏好（同一文档下次默认勾选）
   - 提供"仅分享首层子文档"快捷按钮

## Impact

- **功能兼容性**: 需要确保与现有的分享功能完全兼容
- **UI变更**: 需要在分享对话框中添加控制子文档分享的选项
- **配置管理**: 需要在全局设置和单次分享设置中添加相应的配置项
- **性能考量**: 对于拥有大量子文档的情况，需要考虑分享操作的性能影响
- **存储影响**: 分享更多文档可能会增加存储使用量

### 功能交互设计

1. **与增量分享的协同**：
   - 增量分享时，子文档分享设置自动继承
   - 明确说明：增量检测会包含所有子文档
   - 黑名单过滤优先级最高
   - 子文档数量限制在增量分享中同样生效

2. **与引用文档分享的协同**：
   - 同时开启时，先处理子文档，再处理引用
   - 去重处理，避免同一文档多次分享
   - 在预览中明确标记哪些文档来自子文档，哪些来自引用
   - 优先级：黑名单 > 子文档 > 引用

3. **性能目标**：
   - 100个子文档的获取时间：< 1秒
   - 500个子文档的获取时间：< 3秒
   - 1000个子文档的获取时间：< 5秒
   - 分享进度实时反馈，不阻塞UI

4. **用户预期管理**：
   - 预估将要分享的子文档数量
   - 显示分享所需时间（每个文档约3秒）
   - 显示预估存储空间占用
   - 超过阈值时要求用户确认

### 移动端适配

- 子文档树在移动端以折叠列表显示
- 支持手势展开/折叠
- 预览页面占据90%屏幕，提供更好的可视化体验
- 简化显示，仅显示文档名称和层级

### 异常场景处理

- 子文档已删除：跳过并记录日志，不中断整体分享
- 子文档权限不足：显示明确的错误信息，继续其他文档
- 子文档获取失败：重试3次，失败后降级处理
- 网络异常：保存已分享的进度，支持断点续传

### 国际化支持

- 所有新增文案使用 `subdocuments.xxx` 命名空间
- 关键文案：
  - `subdocuments.enable`: 启用子文档分享
  - `subdocuments.depth`: 子文档深度
  - `subdocuments.preview`: 子文档预览
  - `subdocuments.count`: 子文档数量
  - `subdocuments.confirm`: 超过N个子文档，需要确认

### 用户行为分析

- 统计平均子文档数量
- 记录最大子文档深度
- 收集分享成功率（按子文档数量分段）
- 所有数据匿名化，仅用于产品优化

## 迁移计划

无需特殊迁移，功能将以开关形式提供，默认值将设置为不自动分享子文档，以保持与现有行为的一致性。