# 分享子文档功能 - 任务列表

## Change ID

add-subdocument-sharing

## 当前实现状态

提案已完成，但代码实现尚未开始。当前 ShareOptions 和 SingleDocSetting 仅包含密码和过期时间相关字段，尚未添加 shareSubdocuments 属性。

## 任务列表

### 待办

- [ ] 在SettingKeys.ts中添加CUSTOM_SHARE_SUBDOCUMENTS配置键
- [ ] 在ShareOptions.ts中增加shareSubdocuments属性
- [ ] 在ShareProConfig.ts中添加全局shareSubdocuments配置
- [ ] 在SingleDocSetting.ts中增加shareSubdocuments属性
- [ ] 在SettingService.ts中实现配置的同步和管理方法
- [ ] 在ShareService.ts中实现子文档的递归获取和分享逻辑：
  - [ ] 实现BFS算法递归获取子文档
  - [ ] 实现深度控制（默认所有层级，最多100个）
  - [ ] 支持自定义层级限制（1-10层）
  - [ ] 实现子文档缓存（1分钟）
  - [ ] 实现异步加载子文档列表
  - [ ] 实现批量处理，每次最多10个并发
- [ ] 更新ShareResult接口，添加子文档分享结果字段
- [ ] 在UI中添加子文档分享选项，确保新UI和旧UI都兼容：
  - [ ] 实现子文档树可视化预览
  - [ ] 支持手动排除特定子文档
  - [ ] 显示子文档总数、层级、预估时间
  - [ ] 实现分享进度显示（X/Y、百分比、剩余时间）
  - [ ] 支持取消分享操作
  - [ ] 支持展开/折叠树形图
- [ ] 实现进度反馈与体验优化：
  - [ ] 分享前预估功能（总数、层级、时间、存储空间）
  - [ ] 实时进度显示
  - [ ] 超过50个子文档时提示分批分享
  - [ ] 提供“仅分享首层子文档”快捷选项
- [ ] 实现功能交互设计：
  - [ ] 与增量分享协同（自动继承、黑名单过滤）
  - [ ] 与引用文档分享协同（先子文档后引用、去重）
  - [ ] 明确标记文档来源
- [ ] 实现智能重试机制：
  - [ ] 网络错误自动重试3次（指数退避：1s, 2s, 4s）
  - [ ] 服务端5xx错误延迟30秒重试
  - [ ] 4xx错误立即失败并记录日志
- [ ] 实现批量分享队列管理：
  - [ ] 支持暂停/继续批量分享操作
  - [ ] 支持仅重试失败项功能
  - [ ] 保存分享进度到本地存储
  - [ ] 显示队列状态和预估剩余时间
- [ ] 实现数据统计与分析：
  - [ ] 显示子文档分享统计（总数、层级分布、平均深度）
  - [ ] 展示子文档深度趋势图
  - [ ] 显示最常分享的文档树Top 10
  - [ ] 分析文档树结构复杂度
  - [ ] 提供文档结构优化建议
- [ ] 移动端适配（简化列表、触摸操作、全屏预览）
- [ ] 国际化（subdocuments.xxx 命名空间，包括：enable、depth、preview、treeView、estimate、queue、retrying）
- [ ] 异常场景处理（删除、权限、查询失败）
- [ ] 编写单元测试和集成测试
- [ ] 编写用户文档和使用教程

### 已完成
- [x] 创建子文档分享功能提案和规范文档

## 实施建议

### 优先级
中优先级

### 原因
1. 子文档分享是常见需求，用户经常需要分享整个文档树
2. 实现相对简单，可以使用思源 API 递归获取子文档
3. 与增量分享功能相辅相成，可以提升用户体验

### 建议行动
- 在增量分享功能完成后，优先实现此功能
- 可以与增量分享功能结合，实现更强大的批量分享能力

## 验收标准

1. 用户可以在全局设置中配置是否默认分享子文档
2. 用户可以在单次分享时单独控制是否分享子文档
3. 启用子文档分享时，系统应自动分享该文档下的所有层级子文档
4. 分享后的子文档应能够通过分享链接正常访问
5. 功能应在新UI和旧UI中都能正常使用
6. 对于拥有大量子文档的情况，分享操作应具有良好的性能
7. 子文档树可视化预览工作正常
8. 支持手动排除特定子文档
9. 深度控制功能正常（默认所有层级，最多100个）
10. 自定义层级限制工作正常（1-10层）
11. 分享前预估准确（总数、层级、时间、存储空间）
12. 分享进度实时显示，支持取消操作
13. 超过50个子文档时正确提示分批分享
14. 提供“仅分享首层子文档”快捷选项
15. 与增量分享协同正常（自动继承、黑名单过滤）
16. 与引用文档分享协同正常（先子文档后引用、去重）
17. 文档来源标记明确（子文档/引用）
18. 智能重试机制工作正常：
    - 网络错误自动重试3次（指数退避）
    - 服务端错误延迟重试
    - 批量分享支持暂停/继续/仅重试失败项
19. 性能优化有效：
    - BFS算法递归获取子文档
    - 子文档信息缓存1分钟
    - 异步加载不阻塞主线程
    - 批量处理每次最多10个并发
20. 移动端适配测试通过
21. 国际化文案完整（subdocuments.xxx）
22. 异常场景处理完善（删除、权限、查询失败）
23. 统计分析功能完整：
    - 子文档统计准确（总数、层级分布、平均深度）
    - 子文档深度趋势图正常显示
    - Top 10最常分享文档树列表准确
    - 文档树结构复杂度分析正确
    - 文档结构优化建议合理